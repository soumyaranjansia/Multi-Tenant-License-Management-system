@model LicenseDto
@{
    ViewData["Title"] = "License Details";
    var documents = ViewBag.Documents as List<DocumentDto> ?? new List<DocumentDto>();
}

<div class="row">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h2><i class="bi bi-file-text"></i> License Details</h2>
                <p class="text-muted">@Model.LicenseNumber</p>
            </div>
            <a href="/Licenses" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>

        <!-- License Information Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> License Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">License Number</label>
                        <p class="fw-bold">@Model.LicenseNumber</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Status</label>
                        <p>
                            @if (Model.Status == "Active")
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>
                            }
                            else if (Model.Status == "Expired")
                            {
                                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Expired</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">@Model.Status</span>
                            }
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">License Type</label>
                        <p class="fw-bold">@Model.LicenseType</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Tenant ID</label>
                        <p>@Model.TenantId</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Issue Date</label>
                        <p>@Model.IssueDate.ToString("MMMM dd, yyyy")</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Expiry Date</label>
                        <p>
                            @Model.ExpiryDate.ToString("MMMM dd, yyyy")
                            @if (Model.ExpiryDate < DateTime.UtcNow)
                            {
                                <span class="text-danger">(Expired)</span>
                            }
                            else if (Model.ExpiryDate < DateTime.UtcNow.AddDays(30))
                            {
                                <span class="text-warning">(Expires in @((Model.ExpiryDate - DateTime.UtcNow).Days) days)</span>
                            }
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">License Fee</label>
                        <p class="fw-bold text-success">$@Model.Amount.ToString("N2")</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Information Card -->
        @{
            var payment = ViewBag.Payment as PaymentDetailsDto;
        }
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-credit-card"></i> Payment Information</h5>
            </div>
            <div class="card-body">
                @if (payment != null)
                {
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Payment Status</label>
                            <p>
                                @if (payment.PaymentStatus == "Completed")
                                {
                                    <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Completed</span>
                                }
                                else if (payment.PaymentStatus == "Pending")
                                {
                                    <span class="badge bg-warning"><i class="bi bi-clock-fill"></i> Pending</span>
                                }
                                else if (payment.PaymentStatus == "Failed")
                                {
                                    <span class="badge bg-danger"><i class="bi bi-x-circle-fill"></i> Failed</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@payment.PaymentStatus</span>
                                }
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Amount Paid</label>
                            <p class="fw-bold text-success">₹@payment.Amount.ToString("N2")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Payment Method</label>
                            <p>@payment.PaymentMethod</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Payment Date</label>
                            <p>@payment.CreatedAt.ToString("MMMM dd, yyyy")</p>
                        </div>
                        @if (!string.IsNullOrEmpty(payment.TransactionId))
                        {
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small">Transaction ID</label>
                                <p><code>@payment.TransactionId</code></p>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(payment.InvoiceId))
                        {
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small">Invoice ID</label>
                                <p><code>@payment.InvoiceId</code></p>
                            </div>
                        }
                    </div>
                    @if (payment.PaymentStatus == "Completed" && !string.IsNullOrEmpty(payment.InvoiceId))
                    {
                        <div class="mt-3">
                            <a href="/Licenses/DownloadInvoice?paymentId=@payment.Id&licenseId=@Model.Id" class="btn btn-primary" target="_blank">
                                <i class="bi bi-download"></i> Download Invoice
                            </a>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning mb-0" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Payment Required</strong>
                        <p class="mb-0 mt-2">Payment is required to activate this license. Please complete the payment process.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Documents Card -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-paperclip"></i> Documents (@documents.Count)</h5>
                <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#uploadForm">
                    <i class="bi bi-upload"></i> Upload Document
                </button>
            </div>
            <div class="card-body">
                <!-- Upload Form -->
                <div class="collapse mb-3" id="uploadForm">
                    <div class="border rounded p-3 bg-light">
                        <form asp-action="UploadDocument" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="licenseId" value="@Model.Id" />
                            <div class="mb-2">
                                <label class="form-label">Select File</label>
                                <input type="file" name="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.docx,.xlsx" required />
                                <small class="text-muted">Allowed: PDF, JPG, PNG, DOCX, XLSX (Max 10MB)</small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-upload"></i> Upload
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Documents List -->
                @if (documents.Any())
                {
                    <div class="list-group">
                        @foreach (var doc in documents)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-file-earmark-text text-primary"></i>
                                        <strong>@doc.FileName</strong>
                                        <br/>
                                        <small class="text-muted">
                                            @(doc.FileSizeBytes / 1024.0).ToString("N1") KB • 
                                            Uploaded @doc.UploadedAt.ToString("MMM dd, yyyy")
                                        </small>
                                    </div>
                                    <div class="btn-group">
                                        <a href="/Licenses/DownloadDocument/@doc.Id" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <form asp-action="DeleteDocument" method="post" class="d-inline" 
                                              onsubmit="return confirm('Delete this document?');">
                                            <input type="hidden" name="documentId" value="@doc.Id" />
                                            <input type="hidden" name="licenseId" value="@Model.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-center text-muted py-3">
                        <i class="bi bi-inbox"></i> No documents uploaded yet
                    </p>
                }
            </div>
        </div>
    </div>

    <!-- Actions Sidebar -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 1rem;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                @{
                    var userRoles = Context.Session.GetString("UserRoles") ?? "";
                    var isAdmin = userRoles.Contains("Admin");
                }

                @if (isAdmin)
                {
                    @if (Model.Status == "Pending")
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Pending Status</strong>
                            <p class="mb-0 small">This license can be activated or rejected by admin</p>
                        </div>
                        
                        <form asp-action="Activate" method="post" class="mb-2" onsubmit="return confirm('Activate this license?');">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-check-circle"></i> Activate License
                            </button>
                        </form>
                        
                        <form asp-action="Reject" method="post" class="mb-3" onsubmit="return confirm('Reject this license permanently?');">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-x-circle"></i> Reject License
                            </button>
                        </form>
                    }
                    else if (Model.Status == "Active")
                    {
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-check-circle"></i>
                            <strong>Active License</strong>
                            <p class="mb-0 small">License is currently active and can be deactivated if needed</p>
                        </div>
                        
                        <form asp-action="Deactivate" method="post" class="mb-3" onsubmit="return confirm('Deactivate this license? It will be changed to Pending status.');">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-pause-circle"></i> Deactivate License
                            </button>
                        </form>
                    }
                    
                    <hr/>
                }
                
                @if (Model.ExpiryDate < DateTime.UtcNow.AddDays(60))
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        @if (Model.ExpiryDate < DateTime.UtcNow)
                        {
                            <strong>License Expired!</strong>
                            <p class="mb-0 small">Renew your license to continue using services.</p>
                        }
                        else
                        {
                            <strong>Renewal Due Soon</strong>
                            <p class="mb-0 small">Renew before @Model.ExpiryDate.ToString("MMM dd")</p>
                        }
                    </div>

                    <form asp-action="Renew" method="post" onsubmit="return confirm('Renew this license for 12 months?');">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-success w-100 mb-2">
                            <i class="bi bi-arrow-repeat"></i> Renew License (12 months)
                        </button>
                    </form>
                }
                else
                {
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        <strong>License Valid</strong>
                        <p class="mb-0 small">Expires in @((Model.ExpiryDate - DateTime.UtcNow).Days) days</p>
                    </div>
                }

                <a href="/Licenses/Create" class="btn btn-outline-primary">
                    <i class="bi bi-cart-plus"></i> Buy New License
                </a>

                <button class="btn btn-outline-secondary w-100" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print License
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
}
